sap.ui.define(["sap/ui/base/Object","sap/ui/core/format/DateFormat","sap/m/ComboBox","sap/m/MessageBox","sap/m/MessageToast","sap/m/Table","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/model/resource/ResourceModel","sap/ui/comp/smartfilterbar/SmartFilterBar","sap/ui/table/AnalyticalTable","sap/ui/table/Table"],function(B,D,C,M,a,T,F,S,R,b,A,U){"use strict";function g(e){var d=e.getCustomData();var o={};for(var i=0;i<d.length;i++){o[d[i].getKey()]=d[i].getValue();}return o;}function f(j){var m={};for(var p in j){var v=j[p];if(jQuery.type(v)!=="object"){m[p]=v;}}return m;}function H(e){if(e instanceof Error){e.showMessageBox();}}function G(p){var t="";var m=[];return function(o){var l="";var s=p;var d;for(var h in m){if(m[h].path===p){d=m[h];break;}}if(!d){var e=o.getModel("entitySet").getMetaModel();var P=e.getObject(e.getMetaContext(o.sPath+"/"+p).sPath);if(P){var i=" ";for(var k=0;P.extensions&&k<P.extensions.length;k++){if(P.extensions[k].namespace==="http://www.sap.com/Protocols/SAPData"){switch(P.extensions[k].name){case"display-format":i=P.extensions[k].value;break;case"label":l=P.extensions[k].value;break;case"text":var j=P.extensions[k].value;var n=p.split("/");n[n.length-1]=j;s=n.join("/");break;default:break;}}}if(l===""){l=p;}d={path:p,data:{type:P.type,displayFormat:i,label:l,textPath:s}};m.push(d);}}l=d.data.label;if(d.data.textPath!==""){t=o.getProperty(d.data.textPath);if(t===null||t===undefined){t="";}}else if(o.getProperty(p)!==""){t=o.getProperty(p);}switch(d.data.type){case"Edm.DateTime":if(d.data.displayFormat==="Date"){var q=D.getDateInstance({pattern:"MMM d, yyyy"});var r=new Date(0).getTimezoneOffset()*60*1000;t=q.format(new Date(t.getTime()+r));}break;case"Edm.Boolean":if(t===true){t="{i18n>YES}";}else if(t===false){t="{i18n>NO}";}break;default:break;}return{key:t?t:p,text:l?l+": "+t:t};};}function c(o,d,s,e){function h(){return e.getDialogFragment("sap.suite.ui.generic.template.fragments.DiscardDraftPopover",{onDiscardConfirm:function(){var i=function(w){var x=s.oCRUDManager.deleteEntity();x.then(function(){s.oNavigationController.setRootPageToDirty();s.oNavigationController.unbindChildren(o.getOwnerComponent());if(w&&w.getObject()&&w.getObject().IsActiveEntity){s.oNavigationController.navigateToContext(w,undefined,true);}else{window.history.back();}});var y={discardPromise:x};d.fire(o,"AfterCancel",y);};var j=o.getView().getBindingContext();var E=j.getObject();if(E.hasOwnProperty("HasActiveEntity")&&E.HasActiveEntity&&E.hasOwnProperty("SiblingEntity")){var k=o.getView().getModel();k.read(j.getPath()+"/SiblingEntity",{success:function(w){var x=k.getContext("/"+k.getKey(w));i(x);}});}else{i();}}},"discard");}function l(E){var j=E;var I=-1,k=-1;var w=false;var x=e.getParentTable(E);if(x.getTable){x=x.getTable();}var y=x instanceof A;if(!y){var z=null;var J=e.getTableBinding(x);var L=J&&J.binding;var K=null;if(L){if(x instanceof U){K=L.getContexts();}else if(x instanceof T){K=L.getCurrentContexts();}}var O=null;var P=e.getSelectedContexts(x);var Q=null;if(P&&P.length>0){Q=P[0].getPath();}else if(j){if(x instanceof T){Q=j.getBindingContext()?j.getBindingContext().sPath:null;}}if(L&&L.getContexts&&Q){K=L.getCurrentContexts();for(var i=0;i<K.length;i++){O=K[i];if(O.getPath()===Q){I=i;break;}}}if(x&&I!==-1){k=L.getLength();var V=Math.floor(k/5);if(x instanceof T){V=x.getGrowingThreshold();}else if(x instanceof U){V=x.getThreshold();}var W=jQuery.extend({},L);var X=J.path;var Y=d.getCurrentDisplayObject().dataFromLastPage;if(Y&&Y.nextObjectPageInfo){w=true;}var Z=null;if(W&&x instanceof U){Z=W.getContexts();}else if(W&&x instanceof T){Z=W.getCurrentContexts();}z={"NavPropertyToUse":X,"listBinding":W,"tableMaxItems":k,"growingThreshold":V,"nested":w,"selectedRelativeIndex":I,"objectPageNavigationContexts":Z,"startIndex":0,"endIndex":Z.length-1};var $;var _=x.getModel("_templPriv");var a1=sap.ui.getCore().byId(o.oView.sId);var b1=_.getProperty("/currentPageTitle",$);if(!_.oData.complexTable){$=a1.byId("objectTypeName").getText();}else{$=a1.byId("page-title").getText();}d.addDataForNextPage({"nextObjectPageInfo":z,"previousPageTitle":b1,"currentPageTitle":$});}}}function m(E,j){var k=o.getView().getModel().getMetaModel();var w=j;var x=k.getODataEntitySet(E,false);var y=k.getODataEntityType(x.entityType,false);var z=y.key.propertyRef;var i;var I=s.oDraftController.getDraftContext();if(I.isDraftEnabled(E)){z=z.concat(I.getSemanticKey(E));z.push({name:"IsActiveEntity"},{name:"HasDraftEntity"},{name:"HasActiveEntity"});}if(w.parameters.select&&w.parameters.select.length>0){var J=w.parameters.select.split(",");for(i=0;i<z.length;i++){if(jQuery.inArray(z[i].name,J)===-1){w.parameters.select+=","+z[i].name;}}}return w;}var n,p,q;function r(E){var P=E.getSource().getBindingPath("value");var V=o.getView();var i=s.oDraftController.getDraftContext().hasDraft(V.getBindingContext());if(i){if(!n){var j=V.getModel("_templPriv");n=j.setProperty.bind(j,"/generic/draftIndicatorState");p=n.bind(null,sap.m.DraftIndicatorState.Saved);q=n.bind(null,sap.m.DraftIndicatorState.Clear);}n(sap.m.DraftIndicatorState.Saving);}var k=s.oCRUDManager.modifyEntity(P,E.getSource());if(i){k.then(p,q);}return k;}function t(j){return e.getDialogFragment("sap.suite.ui.generic.template.ListReport.view.fragments.DeleteConfirmation",{onCancel:function(E){var i=E.getSource().getParent();i.close();},onDelete:function(E){var k=o.getView().getModel();var w=k.getMetaModel();var x=w.getODataEntitySet(o.getOwnerComponent().getEntitySet());var y=w.getODataEntityType(x.entityType);var z=y["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeName.String;var I=y["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeNamePlural.String;var J=z.toLowerCase();var K=I.toLowerCase();var L=E.getSource().getParent();var O=L.getModel("delete");var P=O.getProperty("/items");var Q=[];for(var i=0;i<P.length;i++){if(!P[i].draftStatus.locked){if(P.length===O.getProperty("/unsavedChangesItemsCount")||!P[i].draftStatus.unsavedChanges||O.getProperty("/checkboxSelected")){Q.push(P[i].context.getPath());}}}s.oCRUDManager.deleteEntities(Q).then(function(V){var W=Q.length-V.length;if(V.length>0){var X="";if(W>0){X+=(W>1)?e.getText("ST_GENERIC_DELETE_SUCCESS_PLURAL_WITH_COUNT",[W,K]):e.getText("ST_GENERIC_DELETE_SUCCESS_WITH_COUNT",[W,J]);X+="\n";X+=(V.length>1)?e.getText("ST_GENERIC_DELETE_ERROR_PLURAL_WITH_COUNT",[V.length,K]):e.getText("ST_GENERIC_DELETE_ERROR_WITH_COUNT",[V.length,J]);}else{X=(V.length>1)?e.getText("ST_GENERIC_DELETE_ERROR_PLURAL",[K]):e.getText("ST_GENERIC_DELETE_ERROR",[J]);}M.error(X);}else{var Y="";Y=(W>1)?e.getText("ST_GENERIC_DELETE_SUCCESS_PLURAL",[K]):e.getText("ST_GENERIC_DELETE_SUCCESS",[J]);a.show(Y);}j.rebindTable();},function(V){M.error(e.getText("ST_GENERIC_DELETE_ERROR_PLURAL",[Q.length,K]),{styleClass:e.getContentDensityClass()});});L.close();}},"delete");}function u(j){var k=o.getView().getModel();var w=k.getMetaModel();var E=w.getODataEntitySet(o.getOwnerComponent().getEntitySet());var x=w.getODataEntityType(E.entityType);var y=x["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeName.String;var z=x["com.sap.vocabularies.UI.v1.HeaderInfo"].TypeNamePlural.String;var I=y.toLowerCase();var J=z.toLowerCase();var K={items:undefined,itemsCount:j.length,text:{title:undefined,shortText:undefined,unsavedChanges:undefined,longText:undefined},lockedItemsCount:0,unsavedChangesItemsCount:0,checkboxSelected:true};var L=[];for(var i=0;i<j.length;i++){var O=k.getObject(j[i].getPath());var P={};if(!O.IsActiveEntity){P.draft=true;}else if(O.HasDraftEntity){var Q=k.getProperty("DraftAdministrativeData/InProcessByUser",j[i]);if(Q){P.locked=true;P.user=Q;K.lockedItemsCount++;}else{P.unsavedChanges=true;P.user=k.getProperty("DraftAdministrativeData/LastChangedByUser",j[i]);K.unsavedChangesItemsCount++;}}L.push({context:j[i],draftStatus:P});}K.items=L;if(K.lockedItemsCount===K.itemsCount){K.text.title=e.getText("ST_GENERIC_ERROR_TITLE");}else{K.text.title=(K.itemsCount>1)?e.getText("ST_GENERIC_DELETE_TITLE_WITH_COUNT",K.itemsCount):e.getText("ST_GENERIC_DELETE_TITLE");}K.text.unsavedChanges=e.getText("ST_GENERIC_UNSAVED_CHANGES_CHECKBOX",J);if(K.itemsCount>1){if(K.lockedItemsCount===K.itemsCount){K.text.shortText=e.getText("ST_GENERIC_DELETE_LOCKED_PLURAL",J);}else if(K.unsavedChangesItemsCount===K.itemsCount){K.text.shortText=e.getText("ST_GENERIC_DELETE_UNSAVED_CHANGES_PLURAL",J);}else if(K.lockedItemsCount>0){var V=K.itemsCount-K.lockedItemsCount;K.text.shortText=(K.lockedItemsCount>1)?e.getText("ST_GENERIC_CURRENTLY_LOCKED_PLURAL",[K.lockedItemsCount,K.itemsCount,J]):e.getText("ST_GENERIC_CURRENTLY_LOCKED",[K.itemsCount,J]);K.text.shortText+="\n";if(V===K.unsavedChangesItemsCount){K.text.shortText+=(V>1)?e.getText("ST_GENERIC_DELETE_REMAINING_UNSAVED_CHANGES_PLURAL",[J]):e.getText("ST_GENERIC_DELETE_REMAINING_UNSAVED_CHANGES",[I]);}else{K.text.shortText+=(V>1)?e.getText("ST_GENERIC_DELETE_REMAINING_PLURAL",[V,J]):e.getText("ST_GENERIC_DELETE_REMAINING",[I]);}}else{K.text.shortText=e.getText("ST_GENERIC_DELETE_SELECTED_PLURAL",J);}}else{if(K.lockedItemsCount>0){K.text.shortText=e.getText("ST_GENERIC_DELETE_LOCKED",[y,K.items[0].draftStatus.user]);}else if(K.unsavedChangesItemsCount>0){K.text.shortText=e.getText("ST_GENERIC_DELETE_UNSAVED_CHANGES",[I,K.items[0].draftStatus.user]);}else{K.text.shortText=e.getText("ST_GENERIC_DELETE_SELECTED",I);}}return K;}function v(E){M.error(e.getText(E),{styleClass:e.getContentDensityClass()});}function N(E,i,j){var k=i.getObject();var w=o.getOwnerComponent().getAppComponent().getManifestEntry("sap.app");var O=w.crossNavigation.outbounds[g(E).CrossNavigation];var x=e.getNavigationHandler();var y;var z;var I={};if(j){y=j.getDataSuiteFormat();z=x.mixAttributesAndSelectionVariant(k,y);var J=E.getParent().getParent();I={selectionVariant:y,tableVariantID:J.getCurrentVariantId()};}else{jQuery.extend(k,o.getView().getBindingContext().getObject());z=k;}x.navigate(O.semanticObject,O.action,JSON.stringify(z),I,H);}return{onBeforeRebindTable:function(E){var w=E.getSource().getTable();if(w&&w instanceof sap.m.Table){var x=w.getColumns();for(var y=0;y<x.length;y++){if(x[y].getCustomData()[0].getValue()["actionButton"]==="true"){x[y].setPopinDisplay("WithoutHeader");}}}var z=E.getParameter("bindingParams");var P=o.getOwnerComponent().getAggregation("rootControl");var I=E.getSource();var J=P.byId(I.getTable().sId+"-tableLengthText");if(J){z.length=5;}z.parameters=z.parameters||{};var K=o.byId(I.getSmartFilterId());if(K instanceof b){var L=K.getControlByKey("EditState");if(L instanceof C){var O=L.getSelectedKey();switch(O){case"1":z.filters.push(new F("IsActiveEntity","EQ",true));z.filters.push(new F("HasDraftEntity","EQ",false));break;case"2":z.filters.push(new F("IsActiveEntity","EQ",false));break;case"3":z.filters.push(new F("IsActiveEntity","EQ",true));z.filters.push(new F("SiblingEntity/IsActiveEntity","EQ",null));z.filters.push(new F("DraftAdministrativeData/InProcessByUser","NE",""));break;case"4":z.filters.push(new F("IsActiveEntity","EQ",true));z.filters.push(new F("SiblingEntity/IsActiveEntity","EQ",null));z.filters.push(new F("DraftAdministrativeData/InProcessByUser","EQ",""));break;default:var Q=new sap.ui.model.Filter({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});if(z.filters[0]&&z.filters[0].aFilters){var V=z.filters[0];z.filters[0]=new sap.ui.model.Filter([V,Q],true);}else{z.filters.push(Q);}break;}}}m(I.getEntitySet(),z);var W=z.parameters.select&&z.parameters.select.split(",")||[];var X=z.parameters&&z.parameters.expand&&z.parameters.expand.split(",")||[];var Y=I.getEntitySet();if(W&&W.length>0){var Z=I.getModel().getMetaModel();var $=Z.getODataEntitySet(Y);var _=Z.getODataEntityType($.entityType);if(w instanceof T){var a1=z.sorter[0];if(a1&&a1.vGroup){var b1=Z.getODataProperty(_,a1.sPath);var c1=b1["sap:text"]||(b1["com.sap.vocabularies.Common.v1.Text"]||"").Path||"";if(c1){if(jQuery.inArray(c1,W)===-1){z.parameters.select+=","+c1;W.push(c1);}}}}}for(var i=0;i<W.length;i++){if(W[i].indexOf("/")!==-1){var d1=W[i].split("/");d1.pop();var e1=d1.join("/");if(X.indexOf(e1)===-1){X.push(e1);}}}var f1=s.oDraftController.getDraftContext();if(f1.isDraftEnabled(Y)&&f1.isDraftRoot(Y)){if(f1.hasDraftAdministrativeData(Y)){if(W&&W.length>0){if(W.indexOf("DraftAdministrativeData")===-1){z.parameters.select=z.parameters.select+",DraftAdministrativeData";}}if(X.indexOf("DraftAdministrativeData")===-1){X.push("DraftAdministrativeData");}}}if(X.length>0){z.parameters.expand=X.join(",");}var g1=I.getCustomData();var h1={};for(var k=0;k<g1.length;k++){h1[g1[k].getKey()]=g1[k].getValue();}var w=I.getTable();var i1=I.fetchVariant();if((!i1||!i1.sort)&&w instanceof T&&h1.TemplateSortOrder){var j1=h1.TemplateSortOrder.split(", ");for(var j=0;j<j1.length;j++){var k1=j1[j].split(" ");if(k1.length>1){z.sorter.push(new S(k1[0],k1[1]==="true"));}else{z.sorter.push(new S(k1[0]));}}}if(w instanceof T){var a1=z.sorter[0];if(a1&&a1.vGroup){a1.fnGroup=G(a1.sPath);}}},onListNavigate:function(E){l(E);e.navigateFromListItem(E.getBindingContext(),E.getParent());},onListNavigateIntent:function(E,i){var j=E.getBindingContext();N(E,j,i);},onShowDetails:function(E){var i=E.getParent().getParent().getTable();var j=e.getSelectedContexts(i);switch(j.length){case 0:v("ST_GENERIC_NO_ITEM_SELECTED");return;case 1:l(E);e.navigateFromListItem(j[0],i);return;default:v("ST_GENERIC_MULTIPLE_ITEMS_SELECTED");return;}},onShowDetailsIntent:function(E,i){var j=E.getParent().getParent().getTable();var k=e.getSelectedContexts(j);switch(k.length){case 0:v("ST_GENERIC_NO_ITEM_SELECTED");return;case 1:N(E,k[0],i);return;default:v("ST_GENERIC_MULTIPLE_ITEMS_SELECTED");return;}},onChange:r,onCallActionFromList:function(E,i){var j=E.getSource();var O,I,k;var w=e.getParentTable(E.getSource());var x=w.getTable();var y=w.getTableBindingPath();var z=e.getSelectedContexts(x);var J=g(j);var K="";if(J.Type==="com.sap.vocabularies.UI.v1.DataFieldForAction"){if(z.length===0){K="ST_GENERIC_NO_ITEM_SELECTED";}else{s.oCRUDManager.callAction({functionImportPath:J.Action,contexts:z,sourceControl:x,label:J.Label,operationGrouping:J.OperationGrouping,navigationProperty:""}).then(function(V){if(V&&V.length&&V.length===1){k=V[0];if(k.response&&k.response.context&&(!k.actionContext||k.actionContext&&k.response.context.getPath()!==k.actionContext.getPath())){s.oNavigationController.setMeToDirty(o.getOwnerComponent(),y);}}});return;}}else{if(z.length===0){K="ST_GENERIC_NO_ITEM_SELECTED";}else if(z.length===1){var L=e.getNavigationHandler();if(L){var P={};if(z[0]){P=z[0].getObject();}delete P.__metadata;if(i){var Q=i.getDataSuiteFormat()||"{}";P=f(P);O=L.mixAttributesAndSelectionVariant(P,Q).toJSONString();I={selectionVariant:i.getDataSuiteFormat(),tableVariantID:w.getCurrentVariantId()};}else{jQuery.extend(P,o.getView().getBindingContext().getObject());O=f(P);O=JSON.stringify(O);I={};}L.navigate(J.SemanticObject,J.Action,O,I,H);}return;}else{K="ST_GENERIC_MULTIPLE_ITEMS_SELECTED";}}if(K){M.error(e.getText(K),{styleClass:e.getContentDensityClass()});}},onDiscardDraft:function(E){var i=E.getSource();var j=i.getCustomData();var k=h();var w=k.getModel("discard");var P=j&&j[0]?j[0].getValue():sap.m.PlacementType.Top;w.setProperty("/placement",P);var x=o.getView().getBindingContext();var y=x.getObject();var I=y.hasOwnProperty("HasActiveEntity")&&!x.getProperty("IsActiveEntity")&&!x.getProperty("HasActiveEntity");w.setProperty("/isCreateDraft",I);k.openBy(i);},addEntry:function(E,i){var j=e.getParentTable(E.getSource());var k=j.getTableBindingPath();var w=o.getOwnerComponent();if(!e.isDraftEnabled()&&o.getView().getModel().hasPendingChanges()){e.dataLossConfirmation(function(){return s.oCRUDManager.addEntry(j).then(function(x){if(!i){s.oNavigationController.navigateToContext(x.newContext,x.tableBindingPath,false);}s.oNavigationController.setMeToDirty(w,k);});});return null;}return s.oCRUDManager.addEntry(j).then(function(x){if(!i){s.oNavigationController.navigateToContext(x.newContext,x.tableBindingPath,false);}s.oNavigationController.setMeToDirty(w,k);});},deleteEntries:function(E){var i=e.getParentTable(E.getSource());var j=e.getSelectedContexts(i);if(j&&j.length>0){var J=u(j);var k=t(i);var w=k.getModel("delete");w.setData(J);k.open();}else{M.error(e.getText("ST_GENERIC_NO_ITEM_SELECTED"),{styleClass:e.getContentDensityClass()});}},onContactDetails:function(E){var P;if(E.getSource().data("Location")==="Header"){P=E.getSource().getParent().getAggregation("items")[0];}else{P=E.getSource().getParent().getParent().getParent().getParent().getParent().getAggregation("items")[1];}P.bindElement(E.getSource().getBindingContext().getPath());P.openBy(E.getSource());}};}return B.extend("sap.suite.ui.generic.template.lib.CommonEventHandlers",{constructor:function(o,d,s,e){jQuery.extend(this,c(o,d,s,e));}});});
