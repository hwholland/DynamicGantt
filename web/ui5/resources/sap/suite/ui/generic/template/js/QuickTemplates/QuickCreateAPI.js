sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/generic/app/transaction/DraftContext","sap/m/MessageToast"],function(M,D,a){"use strict";var Q=M.extend("sap.suite.ui.generic.template.js.QuickTemplates.QuickCreateAPI",{metadata:{library:"sap.suite.ui.generic.template",properties:{},events:{objectCreated:{parameters:{context:{type:"sap.ui.model.Context"}}},destroyed:{parameters:{collectionItemGuid:{type:"String"}}},autofillLineItems:{parameters:{numberOfLineItems:{type:"Number"}}}}}});Q.EVENT_CONSTANTS={EventChannel:"sap.fiori.cp.quickactions.EventChannel",QUICKCREATE_LINE_ITEMS_FOUND:"LineItemsFound"};Q.CopilotModelName="FioriCopilotODataModel";Q._Instances={};Q.getInstance=function(c){if(!c){return undefined;}if(c.copilotEntity){return Q._Instances[c.copilotEntity.getODataKey()];}else{return Q._Instances[c];}};Q.createAPI=function(c,C,o){function g(){return o.getView().getBindingContext().getObject();}function b(){return o.getQuickCreateItem();}function d(){return C;}function e(){return c;}function f(){return sap.ui.getCore().getModel(Q.CopilotModelName);}function u(i){if(this._bDestroyed){return;}var F=this.getQuickCreateItem();if(F.draftid===i){return;}F.draftid=i;F.copilotEntity.update(F,{error:jQuery.proxy(function(G){jQuery.sap.log.error(G,"","QuickCreateAPI");},this)});}function h(){return C.getAggregation("rootControl");}function j(){return this.oRootView;}function s(i){this.oRootView=i;this.calculateViewHeight(this.oRootView,true);}function k(){if(this.oRootView&&this.oRootView.getController()&&this.oRootView.getController().bDraftEnabled!==undefined){return this.oRootView.getController().bDraftEnabled;}if(!this.oRootView||!this.oRootView.getBindingContext()){return undefined;}var i=new D(this.getQuickCreateModel());return i.hasDraft(this.oRootView.getBindingContext());}function l(){var i=this.getComponentInstance().getModel();if(!i&&this.oRootView){i=this.oRootView.getModel();}return i;}function m(){return o.isCurrentUserCreator();}function n(){if(!this.oRootView){return undefined;}return this.oRootView.getBindingContext();}function p(){var i=this.getQuickCreateRootBindingContext();if(i&&i.getObject()){return i.getObject().__metadata.type;}return undefined;}function _(i,F,P){var G=P.numberOfLineItems;if(G<=0){return;}this.fireAutofillLineItems({numberOfLineItems:G});}function q(){this._attachToModelBindingChanges();if(!this.oRootView){var V=o.oViewUtils.findFirstViewFromControlHierarchy(this.getRootControl());if(V){this.setRootView(V);}}}function r(){if(!this._bBindingChangeAttached){var i=C.getModel();if(i){var F=i.addBinding.bind(i);var G=this;i.addBinding=function(H){F(H);H.attachEvent("change",G._onDataBindingChanged);};this._bBindingChangeAttached=true;}}}function t(){return new Promise(jQuery.proxy(function(i,F){var G=this.getCopilotModel();G.read("/"+G.getKey(this.getQuickCreateItem()),{success:jQuery.proxy(function(H,R){if(H.modeljson){var I=this.getQuickCreateModel();this._loadingJSON=true;if(this.isDraftEnabled()){I.oData=JSON.parse(H.modeljson);}else{var J=JSON.parse(H.modeljson);I.mChangedEntities=J.mChangedEntities;I.mChangeHandles=J.mChangeHandles;I.mDeferredRequests=J.mDeferredRequests;I.oData=J.oData;}I.updateBindings();}if(i){i();}delete this._loadingJSON;},this),error:jQuery.proxy(function(H){if(F){F(H);}},this)});},this));}function v(){if(!this._oUpdateModelJSONTimer){this._oUpdateModelJSONTimer=setTimeout(this._updateModelJSON,1000);}}function w(){if(this._loadingJSON||this._bDestroyed||!this.isCurrentUserCreator()){return;}this._oUpdateModelJSONTimer=null;var F=this.getQuickCreateItem();var G=this.getQuickCreateModel();var H="";if(this.isDraftEnabled()){var I={};var J=Object.keys(G.mChangedEntities);var K=Object.keys(G.oData);var L={};jQuery.each(K,jQuery.proxy(function(i,O){if(G.mChangedEntities[O]){L={};jQuery.extend(L,G.oData[O]);jQuery.extend(L,G.mChangedEntities[O]);I[O]=L;}else{I[O]=G.oData[O];}},this));jQuery.each(J,jQuery.proxy(function(i,O){if(!I[O]){I[O]=G.mChangedEntities[O];}},this));H=JSON.stringify(I);}else{var N={};N.mChangedEntities=G.mChangedEntities;N.mChangeHandles=G.mChangeHandles;N.mDeferredRequests=G.mDeferredRequests;N.oData=G.oData;H=JSON.stringify(N);}if(H===F.modeljson){return;}F.modeljson=H;F.copilotEntity.update(F,{error:jQuery.proxy(function(i){jQuery.sap.log.error(i,"","QuickCreateAPI");},this)});}function x(){return new Promise(jQuery.proxy(function(i,F){var G=this.getQuickCreateModel();if(this.oRootView&&this.oRootView.getBindingContext()){if(this.isDraftEnabled()){G.remove(this.oRootView.getBindingContext().getPath(),{success:function(){a.show("Quick Create Draft has been discarded");i();},error:function(H){F(H);}});}else{G.resetChanges();i();}}else{i();}},this));}function y(V,i){if(V){o.calculateViewHeight(V,i);}}function z(i){o.setComponentContainerHeight(i);}function A(i){if(this._bDestroyed){return;}this.fireObjectCreated({context:i});}function B(){if(this._bDestroyed){return;}if(this._oUpdateModelJSONTimer){clearTimeout(this._oUpdateModelJSONTimer);this._oUpdateModelJSONTimer=null;}delete Q._Instances[this._InstanceKey];if(c&&!c._bIsBeingDestroyed&&!c.bIsDestroyed){c.destroy();}this.oRootView=undefined;sap.ui.getCore().getEventBus().unsubscribe(Q.EVENT_CONSTANTS.EventChannel,Q.EVENT_CONSTANTS.QUICKCREATE_LINE_ITEMS_FOUND,this._onLineItemsFound,this);this.fireDestroyed({collectionItemGuid:this._InstanceKey});M.prototype.destroy.call(this);this._bDestroyed=true;}var E=new Q();jQuery.extend(E,{getCollectionItem:g.bind(E),getQuickCreateItem:b.bind(E),updateDraftID:u.bind(E),getRootControl:h.bind(E),isDraftEnabled:k.bind(E),isCurrentUserCreator:m.bind(E),getQuickCreateRootBindingContext:n.bind(E),getQuickCreateRootEntityType:p.bind(E),_onComponentContainerAfterRendering:q.bind(E),calculateViewHeight:y.bind(E),setComponentContainerHeight:z.bind(E),getQuickCreateModel:l.bind(E),objectCreated:A.bind(E),destroy:B.bind(E),getRootView:j.bind(E),setRootView:s.bind(E),getComponentInstance:d.bind(E),getComponentContainer:e.bind(E),_onDataBindingChanged:v.bind(E),_attachToModelBindingChanges:r.bind(E),loadQuickCreateModelFromJSON:t.bind(E),_updateModelJSON:w.bind(E),getCopilotModel:f.bind(E),discardQuickCreateDraft:x.bind(E),_onLineItemsFound:_.bind(E)});c.addEventDelegate({onAfterRendering:E._onComponentContainerAfterRendering});E._InstanceKey=E.getCollectionItem().copilotEntity.getODataKey();if(Q._Instances[E._InstanceKey]){Q._Instances[E._InstanceKey].destroy();}delete Q._Instances[E._InstanceKey];Q._Instances[E._InstanceKey]=E;sap.ui.getCore().getEventBus().subscribe(Q.EVENT_CONSTANTS.EventChannel,Q.EVENT_CONSTANTS.QUICKCREATE_LINE_ITEMS_FOUND,E._onLineItemsFound,E);C.oQuickCreateAPI=E;return C.oQuickCreateAPI;};return Q;},true);
