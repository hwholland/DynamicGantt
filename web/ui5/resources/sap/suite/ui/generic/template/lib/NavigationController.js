/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/ComponentContainer","sap/ui/core/routing/HashChanger","sap/ui/core/routing/History","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/m/MessagePage","sap/m/Link"],function(B,C,H,a,F,b,M,c,L){"use strict";function g(o,t,n){function T(h,m,D){var i;if(h&&m){if(isNaN(D)){D=0;}i=h.indexOf(m);if(i>-1){h=h.substring(0,i-D);}}return h;}function f(e,s,r){var h=n.oRouter.oHashChanger.getHash(),p;if(e){p=n._getNavigationPath(e,s);n._oTargetContextPath=e.getPath();}else{p=s;}if(p){if(s){if(s.indexOf("/")<0){s="/"+s;}h=T(h,s);h=T(h,"?");if(h){p=h+"/"+p;}}n._navigate(p,r);}}function d(p){var e,s,r,h,E,i,j,I=null,m;if(p){e=p.entitySet;s=p.title;h=p.text;I=p.icon;r=p.replaceURL;}if(e){m=n.oComponent.getModel().getMetaModel();if(m){E=m.getODataEntitySet(e);i=m.getODataEntityType(E.entityType);j=i["com.sap.vocabularies.UI.v1.HeaderInfo"];}if(j&&j.TypeImageUrl&&j.TypeImageUrl.String){I=j.TypeImageUrl.String;}}if(n.oMessagePage){n.oMessagePage.destroy();}n.oMessagePage=new c({title:s,text:h,icon:I,customDescription:new L({text:t.getText("ST_GENERIC_RETURN_TO_MAIN"),press:n.navigateBack.bind(n,r)})});t.oNavContainer.addPage(this.oMessagePage);t.oNavContainer.to(this.oMessagePage);}return{navigateToContext:f,navigateToMessagePage:d};}var N=B.extend("sap.suite.ui.generic.template.lib.NavigationController",{metadata:{library:"sap.suite.ui.generic.template"},constructor:function(o,t){if(!o||!o.getRouter()){throw"No component with router passed";}B.apply(this,arguments);this.oRouter=o.getRouter();this.oViews={};this.oComponent=o;this._oTemplateContract=t;this._sNavigationTargetId=this._oTemplateContract.oNavContainer.getId();this.oRouter.attachRouteMatched(this._handleRouteMatched,this);this.oRouter.attachBypassed(this._handleBypassed,this);this.oRouter._oViews._getViewWithGlobalId=function(v){if(!this.oViews[v.viewName]){var r=this.oRouter.getRoute(v.viewName);if(r&&r._oConfig){this.oViews[v.viewName]=this._createComponentInstance(r._oConfig);}else{this.oViews[v.viewName]=sap.ui.view({viewName:v.viewName,type:v.type,height:"100%"});}}return this.oViews[v.viewName];}.bind(this);this._oHashChanger=H.getInstance();this._generateRoutingMetadata();this._initialise();jQuery.extend(this,g(o,t,this));}});N._sChanges="Changes";N.prototype._initialise=function(){var d;d=this.oComponent.getComponentData();if(d){this._oStartupParameters=d.startupParameters;}if(this._sEntitySet&&this._oStartupParameters&&!this._oHashChanger.getHash()){this._processStartupParameters();}else{this._initialiseRouting();}};N.prototype._processStartupParameters=function(){var m,n=this,d;m=this.oComponent.getModel();m.getMetaModel().loaded().then(function(){var e,E,f,h,s,j;f=function(k,p){var i,l,S=false,K,q;if(p&&k){l=k.length;for(i=0;i<l;i++){S=true;K=k[i];q=K.name||K.PropertyPath;if(!p[q]||p[q].length>1){S=false;break;}}}return S;};if(this._oStartupParameters&&this._oStartupParameters.createWithContext&&this._oStartupParameters.createWithContext=="true"){e=m.getMetaModel().getODataEntitySet(this._sEntitySet);if(e['com.sap.vocabularies.Common.v1.DraftRoot']&&e['com.sap.vocabularies.Common.v1.DraftRoot'].NewAction){var o=m.getMetaModel().getODataFunctionImport(e['com.sap.vocabularies.Common.v1.DraftRoot'].NewAction.String.split("/")[1]);var u={};d=true;if(o&&o.parameter){for(var i=0;i<o.parameter.length;i++){if(o.parameter[i].mode=="In"&&this._oStartupParameters[o.parameter[i].name]){u[o.parameter[i].name]=this._oStartupParameters[o.parameter[i].name];}}sap.ui.core.BusyIndicator.show();m.callFunction("/"+o.name,{success:function(D,r){n._initialiseRouting();sap.ui.core.BusyIndicator.hide();var k=new sap.ui.generic.app.util.ModelUtil(m);var l=k.getContextFromResponse(D);if(l){n.navigateToContext(l,null,true);}else{n.navigateToMessagePage({title:n._oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),replaceURL:true});}},error:function(k){sap.ui.core.BusyIndicator.hide();n.navigateToMessagePage({title:n._oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),replaceURL:true});},method:"POST",urlParameters:u});}else{this.navigateToMessagePage({title:n._oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),replaceURL:true});}}}if(!d){if(this._sEntitySet&&this.oRouter.getRoute(this._sEntitySet)){e=m.getMetaModel().getODataEntitySet(this._sEntitySet);if(e){E=m.getMetaModel().getODataEntityType(e.entityType);}if(E){h=f(E.key.propertyRef,this._oStartupParameters);}if(h){j=m.createKey(this._sEntitySet,this._oStartupParameters);if(j){this._oHashChanger.replaceHash(j);}}else{s=E["com.sap.vocabularies.Common.v1.SemanticKey"];h=f(s,this._oStartupParameters);if(h){this._readObject(s,this._oStartupParameters,m);return;}}}this._initialiseRouting();}}.bind(this));};N.prototype._initialiseRouting=function(){var h;this._oHistory=new a(this._oHashChanger);if(!this._oHashChanger.getHash()){h="";if(this._oStartupParameters&&this._oStartupParameters.route&&this._oStartupParameters.route.length===1){h=this._oStartupParameters.route[0];this._oHashChanger.replaceHash(h);}}this.oRouter.initialize();};N.prototype._preprocessForComplexTable=function(p){for(var P in p){var o=p[P];if(o&&o.component&&o.component.settings&&o.component.settings.sections){for(var s in o.component.settings.sections){var S=o.component.settings.sections[s];if(S.tableMode==="ComplexTable"){o=this._generateRouteForComplexTable(o,s);}}}if(o&&o.pages){o.pages=this._preprocessForComplexTable(o.pages);}p[P]=o;}return p;};N.prototype._generateRouteForComplexTable=function(p,s){var S=p.component.settings.sections[s];var n=S.navigationProperty;var e=S.entitySet;var G=p.component.settings.gridTable;var d=true;var o;if(p.pages){o=this._getApplicableSubPage(p.pages,n,e);}var f={"navigationProperty":n,"entitySet":e,"component":{"name":"sap.suite.ui.generic.template.ListReport","list":true,"settings":{"gridTable":G,"complexListId":s,"smartVariantManagement":d}},"pages":[o]};if(!p.pages){p.pages=[];}p.pages.push(f);return p;};N.prototype._getApplicableSubPage=function(p,n,e){for(var P in p){var o=p[P];if(o.navigationProperty===n&&o.entitySet===e){return o;}}};N.prototype._generateRoutingMetadata=function(){var o=this.oComponent.getConfig(),t,T;if(!o.pages||!o.pages.length||o.pages.length===0){throw new Error("Route Configuration missing");}else if(o.pages.length>1){throw new Error("Currently only one Top route supported");}else{o.pages=this._preprocessForComplexTable(o.pages);t=o.pages[0];this._sEntitySet=t.entitySet;T=this._createRoute(t,"root",0);this.oRouter.addRoute(T);this._createQueryRoute(T);this._createChildRoutes(t,0,null);}};N.prototype._createChildRoutes=function(r,l,p){var i,d;if(r.pages){d=r.pages.length;for(i=0;i<d;i++){this._createRoutes(r.pages[i],(l+1),p);}}};N.prototype._createRoutes=function(r,l,p){if(r.component){var n=this._createRoute(r,r.component.list?"aggregation":"detail",l,p);this.oRouter.addRoute(n);this._createQueryRoute(n);this._createChildRoutes(r,l,n);}};N.prototype._createQueryRoute=function(r){var q=jQuery.extend({},r);q.name=r.name+"query";q.pattern=r.pattern+"{?query}";this.oRouter.addRoute(q);};N.prototype._createRoute=function(r,o,l,p){var P,n;P=r.navigationProperty||r.entitySet;n=jQuery.extend({},r);n.path="/"+r.entitySet;n.operation=o;n.viewLevel=l;n.template=r.component?(r.component.name||r.component):r.template;switch(o){case"root":n.name='root';n.pattern='';break;case"aggregation":n.name=P+"~aggregation";n.pattern=P;break;default:n.name=P;n.pattern=P+"({keys"+l+"})";break;}if(p){n.name=p.name+"/"+n.name;n.pattern=p.pattern+"/"+n.pattern;n.parentEntitySet=p.entitySet;}n.view=n.name;n.controlId=this._sNavigationTargetId;n.controlAggregation="pages";return n;};N.prototype._createComponentInstance=function(r){var t,E,o,s;t=r.template;E=r.entitySet;s={appComponent:this.oComponent,isLeaf:!r.pages||!r.pages.length,subPages:r.pages,entitySet:E,navigationProperty:r.navigationProperty,routeConfig:r,componentData:{preprocessorsData:{}}};if(r.component.settings){jQuery.extend(s,r.component.settings);}try{o=new C({name:t,propagateModel:true,width:'100%',height:'100%',handleValidation:true,settings:s});return o;}catch(e){throw new Error("Component "+t+" could not be loaded");}};N.prototype._handleRouteMatched=function(e){this._oTemplateContract.oApplication.onRouteMatched(e);var v,r,k,K,p;v=e.getParameter("view");r=e.getParameter("config");if(this._oTargetContextPath){p=this._oTargetContextPath;delete this._oTargetContextPath;}else if(r.operation!=="root"){if(r.operation==="aggregation"){p="/"+r.pattern;}else{p=this._getContextPath(r);}K=e.getParameter("arguments");delete K["?query"];if(K){for(k in K){p=p.replace("{"+k+"}",K[k]);}}}this._activateView(v,p);};N.prototype._activateView=function(v,p,d){var o,O,e,V;if(v){if(v.getComponentInstance){e=v.getComponentInstance();if(!e){V={onBeforeRendering:function(){v.removeEventDelegate(V,this);if(v.getComponentInstance&&v.getComponentInstance()){this._activateView(v,p,true);}}};v.addEventDelegate(V,this);return;}}o=this._oTemplateContract.oNavContainer.getPreviousPage();if(!d&&(o||v!==this._oTemplateContract.oNavContainer.getCurrentPage())){o=this._oTemplateContract.oNavContainer.getCurrentPage();}if(o&&o.getComponentInstance){O=o.getComponentInstance();if(O&&O.onDeactivate){O.onDeactivate();}}if(e){e.onActivate(p);}}};N.prototype._navigate=function(h,r){if(!h){h="";}if(r){this.oRouter.oHashChanger.replaceHash(h);}else{this.oRouter.oHashChanger.setHash(h);}};N.prototype.navigateToRoot=function(r){this._navigate("",r);};N.prototype.navigateBack=function(r){this._navigate(this._oHistory?this._oHistory.getPreviousHash():"",r);};N.prototype._getNavigationPath=function(t,n){var p,P,e;p=t.getPath().substring(1);P=p.split('(');if(P[0]){e=P[0];}if(n){p=p.replace(e,n);if(p.indexOf("/")===0){p=p.substring(1);}}return p;};N.prototype._getContextPath=function(r){var p,P,i;if(r){p=r.pattern;P=r.navigationProperty||r.entitySet;if(p&&P){i=p.indexOf("{?query}");if(i>0){p=p.substring(0,i);}i=-1;P+="({keys";i=p.indexOf(P);if(i>0){p=p.substring(i);}if(r.navigationProperty){p=p.replace(r.navigationProperty,r.entitySet);}p="/"+p;}}return p;};N.prototype._handleBypassed=function(){this._oTemplateContract.oApplication.onBypassed();this.navigateToMessagePage({title:this._oTemplateContract.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),replaceURL:true});};N.prototype.getViews=function(){return this.oViews;};N.prototype.getNavContainer=function(){return this._oTemplateContract.oNavContainer;};N.prototype._readObject=function(k,p,m){var i,l,P,v,f=[];if(k&&p&&m){l=k.length;for(i=0;i<l;i++){P=k[i].PropertyPath;v=p[P][0];f.push(new F(P,b.EQ,v));}m.read("/"+this._sEntitySet,{filters:f,success:function(r){var R,i,d,K;if(r&&r.results){d=r.results.length;for(i=0;i<d;i++){R=r.results[i];if(R&&R.IsActiveEntity){break;}R=null;}if(!R){R=r.results[0];}}if(R){K=m.getKey(R);}if(K){this._oHashChanger.replaceHash(K);}this._initialiseRouting();}.bind(this),error:function(e){this._initialiseRouting();}.bind(this)});}};N.prototype.setRootPageToDirty=function(){var v=this.getViews();if(v&&v.root){var i=v.root.getComponentInstance();if(i&&typeof i.setIsRefreshRequired==="function"){i.setIsRefreshRequired(true);}}};N.prototype.setParentToDirty=function(o,n,d){var s,p,P,r,m=this._oTemplateContract.componentRegistry;var e=o.getId();s=o.getComponentContainer().getSettings();var R=s&&s.routeConfig;if(R){if(R.viewLevel===0){return false;}else{for(var f in m){if(f!==e){p=m[f].oComponent.getComponentContainer().getSettings();if(p&&p.routeConfig&&p.routeConfig.viewLevel===(R.viewLevel-1)&&(R.viewLevel===1||p.routeConfig.entitySet===R.parentEntitySet)){P=m[f].oComponent;if(n){r=m[f].oGenericData.mRefreshInfos;r[n]=true;}else{if(typeof P.setIsRefreshRequired==="function"){P.setIsRefreshRequired(true);}}break;}}}if(P&&!d){this._setComplexTableChildrenToDirty(P,n);}}}};N.prototype.setMeToDirty=function(o,n){if(n){var r=this._oTemplateContract.componentRegistry[o.getId()].oGenericData.mRefreshInfos;r[n]=true;}else{if(typeof o.setIsRefreshRequired==="function"){o.setIsRefreshRequired(true);}}var s=o.getComponentContainer().getSettings();var d=sap.suite.ui.generic.template.js.AnnotationHelper.isComplexTable(s.routeConfig);if(d){this.setParentToDirty(o,n,true);}else{this._setComplexTableChildrenToDirty(o,n);}};N.prototype._setComplexTableChildrenToDirty=function(o,n){var p,d,i,m=this._oTemplateContract.componentRegistry;p=o.getComponentContainer().getSettings();for(var s in m){d=m[s].oComponent.getComponentContainer().getSettings();i=sap.suite.ui.generic.template.js.AnnotationHelper.isComplexTable(d.routeConfig);if(i){if(p.routeConfig&&p.routeConfig.viewLevel===(d.routeConfig.viewLevel-1)&&(p.routeConfig.entitySet===d.routeConfig.parentEntitySet)){var e=m[s].oComponent;if(typeof e.setIsRefreshRequired==="function"){e.setIsRefreshRequired(true);}}}}};N.prototype._getChildren=function(v,o){var d=[];var o=o||this.getViews();var s=o[v].getSettings();for(var O in o){var e=o[O].getSettings();if(s.routeConfig.viewLevel+1===e.routeConfig.viewLevel&&s.routeConfig.entitySet===e.routeConfig.parentEntitySet){d.push(O);}}return d;};N.prototype._getSuccessors=function(v,V){var s=[];var d=this._getChildren(v,V);for(var i=0;i<d.length;i++){s=s.concat(this._getSuccessors(d[i],V));}return s.concat(d);};N.prototype.unbindChildren=function(o){var v=this.getViews();var m=o.getId();for(var V in v){var I=v[V].getComponentInstance();if(I&&I.getId()===m){var s=this._getSuccessors(V,v);for(var i=0;i<s.length;i++){v[s[i]].unbindElement();}}}};N.prototype.destroy=function(){B.prototype.destroy.apply(this,arguments);if(this._oHistory&&this._oHistory.destroy){this._oHistory.destroy();}this._oHistory=null;this.oRouter=null;this.oViews=null;this.oComponent=null;};return N;});
